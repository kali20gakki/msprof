#!/usr/bin/env python
# coding=utf-8
"""
function:
Copyright Huawei Technologies Co., Ltd. 2021. All rights reserved.
"""
import os
import shutil
import unittest

from framework.offset_calculator import FileCalculator
from framework.offset_calculator import FileReverseCalculator

NAMESPACE = 'framework.file_dispatch'


class TestFileCalculator(unittest.TestCase):
    HWTS_LOG_SIZE = 64
    FILE_0 = 'hwts.data.0.slice_0'
    FILE_1 = 'hwts.data.0.slice_1'

    def setup_class(self):
        self.current_path = "./file_calculator_test/"
        self.file_folder = "data/"
        self.file_dict = {
            self.FILE_0:b'\xc0\x00\xd3k\x00\x00\x02\x00\xed\xb9^I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd1\x00\xd3k\x00\x00\x02\x00/\xbe^I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\xd3k\x00\x00\x03\x00\xb5\x04_I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf1\x00\xd3k\x00\x00\x03\x00s\x06_I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd3k\x00\x00\x04\x00I?_I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x11\x00\xd3k\x00\x00\x04\x00\xdd@_I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x00\xd3k\x00\x00\x05\x00\xc6z_I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x001\x00\xd3k\x00\x00\x05\x00\x87|_I\xdc\x06\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00',
            self.FILE_1:b'@\x00\xd3k\x00\x00\x03\x00wn\x7f]\xdc\x06\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00Q\x00\xd3k\x00\x00\x03\x00\x94t\x7f]\xdc\x06\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        }

        if not os.path.exists(self.current_path):
            os.mkdir(self.current_path)
        if not os.path.exists(self.current_path + self.file_folder):
            os.mkdir(self.current_path + self.file_folder)

        for file_name, file_content in self.file_dict.items():
            with open(self.current_path + self.file_folder + file_name, 'wb') as _file_writer:
                _file_writer.write(file_content)

    def teardown_class(self):
        if os.path.exists(self.current_path):
            shutil.rmtree(self.current_path)

    def test_prepare_process_0(self):
        expect_res = 512
        offset_count = 0
        total_count = 8
        file_calculator = FileCalculator([self.FILE_0, self.FILE_1], self.HWTS_LOG_SIZE, self.current_path,
                                         offset_count, total_count)
        binary_data = file_calculator.prepare_process()
        self.assertEqual(expect_res, len(binary_data))

    def test_prepare_process_1(self):
        expect_res = 128
        offset_count = 0
        total_count = 2
        file_calculator = FileCalculator([self.FILE_0, self.FILE_1], self.HWTS_LOG_SIZE, self.current_path,
                                         offset_count, total_count)
        binary_data = file_calculator.prepare_process()
        self.assertEqual(expect_res, len(binary_data))


class TestFileReverseCalculator(unittest.TestCase):
    FILE_0 = 'aicore.data.0.slice_0'
    FILE_1 = 'aicore.data.0.slice_1'

    CURRENT_PATH = "./file_reverse_calculator_test/"
    FILE_FOLDER = "data/"
    FILE_DICT = {
        FILE_0: b'\x00\x00\x00\x00\x00\x00\x00\x00\xb4\x97\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00W\xdb\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xde/\x1e\x00\x00\x00\x00'
                     b'\x00\xfcm\x1b\x00\x00\x00\x00\x00\xb5v\x00\x00\x00\x00\x00\x00q\x00\x00\x00\x00\x00\x00\x00'
                     b'\xd5\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00u\x00\xd3k\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00|\x15\x12\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x87&\x0e\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10}\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00mJ\x05\x00\x00\x00\x00\x00Kc\x04\x00\x00\x00\x00\x00\x04\xba\x04\x00\x00\x00\x00'
                     b'\x00M\x00\x00\x00\x00\x00\x00\x00\xd5\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x85\x00\xd3k\x00'
                     b'\x00Q\x00\x00\x00\x00\x00\x00\x00\x00\x00)\xbf\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\xfb\xd7\x1d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00kx\x01\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1b6\x10\x00\x00\x00\x00\x00\xfd\x17\x00\x00'
                     b'\x00\x00\x00\x00H\xd2\x00\x00\x00\x00\x00\x00e\x00\x00\x00\x00\x00\x00\x00~\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x95\x00\xd3k\x00\x00R\x00\x00\x00\x00\x00\x00\x00\x00\x00\xae+\x19\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd8\x8a\x17\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x9ep\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00=d\x0c\x00'
                     b'\x00\x00\x00\x00\xf5\x9b\x04\x00\x00\x00\x00\x00u\x18\x01\x00\x00\x00\x00\x00s\x00\x00\x00'
                     b'\x00\x00\x00\x00~\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa5\x00\xd3k\x00\x00\x05\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\xd8\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x16\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00O\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x96\x01\x00\x00\x00\x00\x00\x00\x89\x00\x00\x00\x00',
        FILE_1: b'\x00\x00\x00)\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\xd1\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\xb5\x00\xd3k\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00\x00\x00/\x05'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00K\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\\\x02\x00\x00\x00\x00\x00\x00\xa7\x00\x00\x00\x00\x00\x00\x004\x00\x00\x00\x00\x00\x00\x00'
                     b'\x02\x00\x00\x00\x00\x00\x00\x00\xd1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc5\x00\xd3k\x00'
                     b'\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc4\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x16\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00O\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00A\x01\x00\x00\x00\x00\x00\x00s\x00'
                     b'\x00\x00\x00\x00\x00\x00)\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\xd0'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd5\x00\xd3k\x00\x00\x06\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x92\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00K\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00z\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\xe6\x01\x00\x00\x00\x00\x00\x00\x9f\x00\x00\x00\x00\x00\x00\x00-\x00\x00'
                     b'\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\xd0\x00\x00\x00\x00\x00\x00\x00\x00\x00'
                     b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
        }

    def setup_class(self):
        if not os.path.exists(self.CURRENT_PATH):
            os.mkdir(self.CURRENT_PATH)
        if not os.path.exists(self.CURRENT_PATH + self.FILE_FOLDER):
            os.mkdir(self.CURRENT_PATH + self.FILE_FOLDER)

        for file_name, file_content in self.FILE_DICT.items():
            with open(self.CURRENT_PATH + self.FILE_FOLDER + file_name, 'wb') as _file_writer:
                _file_writer.write(file_content)

    def teardown_class(self):
        if os.path.exists(self.CURRENT_PATH):
            shutil.rmtree(self.CURRENT_PATH)

    def test_read_file_from_tail(self):
        file_rev_calculator = FileReverseCalculator(
            self.CURRENT_PATH, [self.FILE_0, self.FILE_1], 128, 0, (4, 123))
        file_rev_calculator.read_file_from_tail()
        self.assertEqual(file_rev_calculator.is_find, False)

    def test_read_file_from_tail_find(self):
        file_rev_calculator = FileReverseCalculator(
            self.CURRENT_PATH, [self.FILE_0, self.FILE_1], 128, 0, (126, 81))
        file_rev_calculator.read_file_from_tail()
        self.assertEqual(file_rev_calculator.is_find, True)
        self.assertEqual(file_rev_calculator.tail_aic_cnt, 5)

    def test_read_file_from_tail_no_find(self):
        file_rev_calculator = FileReverseCalculator(
            self.CURRENT_PATH, [self.FILE_0, self.FILE_1], 128, 1, (126, 81))
        file_rev_calculator.read_file_from_tail()
        self.assertEqual(file_rev_calculator.is_find, False)
